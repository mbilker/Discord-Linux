'use strict';

var _electron = require('electron');

var _superagentPatch = require('./superagentPatch');

var _superagentPatch2 = _interopRequireDefault(_superagentPatch);

var _webrtc = require('./lib/voice_engine/webrtc');

var _webrtc2 = _interopRequireDefault(_webrtc);

var _Constants = require('./Constants');

var _Constants2 = require('./lib/voice_engine/native/Constants');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

localStorage.debug = '*';

//const _VoiceEngine = require('./lib/voice_engine/webrtc');
//const VoiceEngine = _VoiceEngine && _VoiceEngine['__esModule'] ? _VoiceEngine.default ? _VoiceEngine;


navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
window.AudioContext = window.AudioContext || window.webkitAudioContext || navigator.mozAudioContext;
window.RTCPeerConnection = window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection;
window.RTCSessionDescription = window.RTCSessionDescription || window.mozRTCSessionDescription || window.webkitRTCSessionDescription;

var _deInterop = function _deInterop(cb) {
  if (cb && cb['__INTEROP_CALLBACK'] && cb.name) {
    return function () {
      for (var _len = arguments.length, args = Array(_len), _key = 0; _key < _len; _key++) {
        args[_key] = arguments[_key];
      }

      if (cb.name !== 'set-on-speaking-callback-reply' && cb.name !== 'set-on-voice-callback-reply' && cb.name !== 'set-device-change-callback-reply') {
        var _console;

        (_console = console).log.apply(_console, [cb.name + ':'].concat(args));
      }
      _electron.ipcRenderer.send.apply(_electron.ipcRenderer, [cb.name].concat(args));
    };
  }
};

_electron.ipcRenderer.on('get-token-and-fingerprint', function (ev, _ref) {
  var rawToken = _ref.token;
  var fingerprint = _ref.fingerprint;

  var token = (rawToken || '').replace(/"/g, '');

  console.log('get-token-and-fingerprint: token=' + token + ' fingerprint=' + fingerprint);
  window.token = token;
  window.fingerprint = fingerprint;

  localStorage.setItem('token', token);
  localStorage.setItem('fingerprint', fingerprint);
});
_electron.ipcRenderer.on('create-transport', function (ev, ssrc, userId, address, port, cb) {
  console.log('create-transport:', ssrc, userId, address, port, cb);
  _webrtc2.default.enable(function (err) {
    console.log('VoiceEngine.enable:', err);
  });
  _webrtc2.default.connect(ssrc, userId, address, port, _deInterop(cb));
});
_electron.ipcRenderer.on('set-on-speaking-callback', function (ev, cb) {
  console.log('set-on-speaking-callback:', cb);
  _webrtc2.default.onSpeaking(_deInterop(cb));
});
_electron.ipcRenderer.on('set-on-voice-callback', function (ev, cb) {
  console.log('set-on-voice-callback:', cb);
  _webrtc2.default.onVoiceActivity(_deInterop(cb));
});
_electron.ipcRenderer.on('on-connection-state', function (ev, cb) {
  console.log('on-connection-state:', cb);
  _webrtc2.default.onConnectionState(_deInterop(cb));
});
_electron.ipcRenderer.on('set-device-change-callback', function (ev, cb) {
  console.log('set-device-change-callback:', cb);
  _webrtc2.default.onDevicesChanged(_deInterop(cb));
});
_electron.ipcRenderer.on('get-input-devices', function (ev, cb) {
  console.log('get-input-devices:', cb);
  _webrtc2.default.getInputDevices(_deInterop(cb));
});
['setEchoCancellation', 'setNoiseSuppression', 'setAutomaticGainControl'].forEach(function (method) {
  _electron.ipcRenderer.on(method, function (ev, enabled) {
    console.log(method + ':', enabled);
    _webrtc2.default[method](enabled);
  });
});
_electron.ipcRenderer.on('set-input-device', function (ev, inputDeviceIndex) {
  console.log('set-input-device:', inputDeviceIndex);
  _webrtc2.default.getInputDevices(function (devices) {
    var device = devices[inputDeviceIndex].id;
    _webrtc2.default.setInputDevice(device);
  });
});
_electron.ipcRenderer.on('set-input-mode', function (ev, mode, options) {
  console.log('set-input-mode:', mode, options);
  if (_Constants2.NATIVE_TO_REGULAR[mode] === _Constants.InputModes.PUSH_TO_TALK) {
    options = Object.assign({}, options, { delay: options.pttDelay });
  }
  _webrtc2.default.setInputMode(_Constants2.NATIVE_TO_REGULAR[mode], options);
});
_electron.ipcRenderer.on('get-output-devices', function (ev, cb) {
  console.log('get-output-devices:', cb);
  _webrtc2.default.getOutputDevices(_deInterop(cb));
});
_electron.ipcRenderer.on('set-output-volume', function (ev, volume) {
  console.log('set-output-volume:', volume);
  _webrtc2.default.setOutputVolume(volume);
});
_electron.ipcRenderer.on('set-self-mute', function (ev, mute) {
  console.log('set-self-mute:', mute);
  _webrtc2.default.setSelfMute(mute);
});
_electron.ipcRenderer.on('set-self-deafen', function (ev, deaf) {
  console.log('set-self-deafen:', deaf);
  _webrtc2.default.setSelfDeaf(deaf);
});
_electron.ipcRenderer.on('set-local-mute', function (ev, userId, mute) {
  console.log('set-local-mute:', userId, mute);
  _webrtc2.default.setLocalMute(userId, mute);
});
_electron.ipcRenderer.on('set-local-volume', function (ev, userId, volume) {
  console.log('set-local-volume:', userId, volume);
  _webrtc2.default.setLocalVolume(userId, volume);
});
_electron.ipcRenderer.on('destroy-transport', function (ev) {
  console.log('destroy-transport');
  _webrtc2.default.disconnect();
});
_electron.ipcRenderer.on('handle-speaking', function (ev, userId, speaking) {
  //console.log('handle-speaking:', userId, speaking);
  _webrtc2.default.handleSpeaking(userId, speaking);
});
_electron.ipcRenderer.on('handle-session-description', function (ev, obj) {
  console.log('handle-session-description:', obj);
  _webrtc2.default.handleSessionDescription(obj);
});
_electron.ipcRenderer.on('merge-users', function (ev, users) {
  console.log('merge-users:', users);
  users.forEach(function (user) {
    _webrtc2.default.createUser(user.id, user.ssrc);
  });
});
_electron.ipcRenderer.on('destroy-user', function (ev, userId) {
  console.log('destroy-user:', userId);
  _webrtc2.default.destroyUser(userId);
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3ZvaWNlX2VuZ2luZS1zcmMvaW5kZXguanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBRUEsYUFBYSxLQUFiLEdBQXFCLEdBQXJCOzs7Ozs7QUFXQSxVQUFVLFlBQVYsR0FBeUIsVUFBVSxZQUFWLElBQ3ZCLFVBQVUsa0JBQVYsSUFDQSxVQUFVLGVBQVY7QUFDRixPQUFPLFlBQVAsR0FBc0IsT0FBTyxZQUFQLElBQ3BCLE9BQU8sa0JBQVAsSUFDQSxVQUFVLGVBQVY7QUFDRixPQUFPLGlCQUFQLEdBQTJCLE9BQU8saUJBQVAsSUFDekIsT0FBTyxvQkFBUCxJQUNBLE9BQU8sdUJBQVA7QUFDRixPQUFPLHFCQUFQLEdBQStCLE9BQU8scUJBQVAsSUFDN0IsT0FBTyx3QkFBUCxJQUNBLE9BQU8sMkJBQVA7O0FBRUYsSUFBTSxhQUFhLFNBQWIsVUFBYSxDQUFDLEVBQUQsRUFBUTtBQUN6QixNQUFJLE1BQU0sR0FBRyxvQkFBSCxDQUFOLElBQWtDLEdBQUcsSUFBSCxFQUFTO0FBQzdDLFdBQU8sWUFBYTt3Q0FBVDs7T0FBUzs7QUFDbEIsVUFBSSxHQUFHLElBQUgsS0FBWSxnQ0FBWixJQUNBLEdBQUcsSUFBSCxLQUFZLDZCQUFaLElBQ0EsR0FBRyxJQUFILEtBQVksa0NBQVosRUFBZ0Q7OztBQUNsRCw2QkFBUSxHQUFSLGtCQUFlLEdBQUcsSUFBSCxlQUFlLEtBQTlCLEVBRGtEO09BRnBEO0FBS0EsNEJBQVksSUFBWiwrQkFBaUIsR0FBRyxJQUFILFNBQVksS0FBN0IsRUFOa0I7S0FBYixDQURzQztHQUEvQztDQURpQjs7QUFhbkIsc0JBQVksRUFBWixDQUFlLDJCQUFmLEVBQTRDLFVBQVMsRUFBVCxRQUE2QztNQUF4QixnQkFBUCxNQUErQjtNQUFkLCtCQUFjOztBQUN2RixNQUFNLFFBQVEsQ0FBQyxZQUFZLEVBQVosQ0FBRCxDQUFpQixPQUFqQixDQUF5QixJQUF6QixFQUErQixFQUEvQixDQUFSLENBRGlGOztBQUd2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bUJBQVksd0JBQVosQ0FBcUMsR0FBckMsRUFGNkQ7Q0FBbEIsQ0FBN0M7QUFJQSxzQkFBWSxFQUFaLENBQWUsYUFBZixFQUE4QixVQUFTLEVBQVQsRUFBYSxLQUFiLEVBQW9CO0FBQ2hELFVBQVEsR0FBUixDQUFZLGNBQVosRUFBNEIsS0FBNUIsRUFEZ0Q7QUFFaEQsUUFBTSxPQUFOLENBQWMsVUFBQyxJQUFELEVBQVU7QUFDdEIscUJBQVksVUFBWixDQUF1QixLQUFLLEVBQUwsRUFBUyxLQUFLLElBQUwsQ0FBaEMsQ0FEc0I7R0FBVixDQUFkLENBRmdEO0NBQXBCLENBQTlCO0FBTUEsc0JBQVksRUFBWixDQUFlLGNBQWYsRUFBK0IsVUFBUyxFQUFULEVBQWEsTUFBYixFQUFxQjtBQUNsRCxVQUFRLEdBQVIsQ0FBWSxlQUFaLEVBQTZCLE1BQTdCLEVBRGtEO0FBRWxELG1CQUFZLFdBQVosQ0FBd0IsTUFBeEIsRUFGa0Q7Q0FBckIsQ0FBL0IiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge2lwY1JlbmRlcmVyfSBmcm9tICdlbGVjdHJvbic7XG5cbmxvY2FsU3RvcmFnZS5kZWJ1ZyA9ICcqJztcblxuaW1wb3J0IG1vbmtleVBhdGNoIGZyb20gJy4vc3VwZXJhZ2VudFBhdGNoJztcblxuLy9jb25zdCBfVm9pY2VFbmdpbmUgPSByZXF1aXJlKCcuL2xpYi92b2ljZV9lbmdpbmUvd2VicnRjJyk7XG4vL2NvbnN0IFZvaWNlRW5naW5lID0gX1ZvaWNlRW5naW5lICYmIF9Wb2ljZUVuZ2luZVsnX19lc01vZHVsZSddID8gX1ZvaWNlRW5naW5lLmRlZmF1bHQgPyBfVm9pY2VFbmdpbmU7XG5pbXBvcnQgVm9pY2VFbmdpbmUgZnJvbSAnLi9saWIvdm9pY2VfZW5naW5lL3dlYnJ0Yyc7XG5cbmltcG9ydCB7SW5wdXRNb2Rlc30gZnJvbSAnLi9Db25zdGFudHMnO1xuaW1wb3J0IHtOQVRJVkVfVE9fUkVHVUxBUn0gZnJvbSAnLi9saWIvdm9pY2VfZW5naW5lL25hdGl2ZS9Db25zdGFudHMnO1xuXG5uYXZpZ2F0b3IuZ2V0VXNlck1lZGlhID0gbmF2aWdhdG9yLmdldFVzZXJNZWRpYSB8fFxuICBuYXZpZ2F0b3Iud2Via2l0R2V0VXNlck1lZGlhIHx8XG4gIG5hdmlnYXRvci5tb3pHZXRVc2VyTWVkaWE7XG53aW5kb3cuQXVkaW9Db250ZXh0ID0gd2luZG93LkF1ZGlvQ29udGV4dCB8fFxuICB3aW5kb3cud2Via2l0QXVkaW9Db250ZXh0IHx8XG4gIG5hdmlnYXRvci5tb3pBdWRpb0NvbnRleHQ7XG53aW5kb3cuUlRDUGVlckNvbm5lY3Rpb24gPSB3aW5kb3cuUlRDUGVlckNvbm5lY3Rpb24gfHxcbiAgd2luZG93Lm1velJUQ1BlZXJDb25uZWN0aW9uIHx8XG4gIHdpbmRvdy53ZWJraXRSVENQZWVyQ29ubmVjdGlvbjtcbndpbmRvdy5SVENTZXNzaW9uRGVzY3JpcHRpb24gPSB3aW5kb3cuUlRDU2Vzc2lvbkRlc2NyaXB0aW9uIHx8XG4gIHdpbmRvdy5tb3pSVENTZXNzaW9uRGVzY3JpcHRpb24gfHxcbiAgd2luZG93LndlYmtpdFJUQ1Nlc3Npb25EZXNjcmlwdGlvbjtcblxuY29uc3QgX2RlSW50ZXJvcCA9IChjYikgPT4ge1xuICBpZiAoY2IgJiYgY2JbJ19fSU5URVJPUF9DQUxMQkFDSyddICYmIGNiLm5hbWUpIHtcbiAgICByZXR1cm4gKC4uLmFyZ3MpID0+IHtcbiAgICAgIGlmIChjYi5uYW1lICE9PSAnc2V0LW9uLXNwZWFraW5nLWNhbGxiYWNrLXJlcGx5JyAmJlxuICAgICAgICAgIGNiLm5hbWUgIT09ICdzZXQtb24tdm9pY2UtY2FsbGJhY2stcmVwbHknICYmXG4gICAgICAgICAgY2IubmFtZSAhPT0gJ3NldC1kZXZpY2UtY2hhbmdlLWNhbGxiYWNrLXJlcGx5Jykge1xuICAgICAgICBjb25zb2xlLmxvZyhgJHtjYi5uYW1lfTpgLCAuLi5hcmdzKTtcbiAgICAgIH1cbiAgICAgIGlwY1JlbmRlcmVyLnNlbmQoY2IubmFtZSwgLi4uYXJncyk7XG4gICAgfTtcbiAgfVxufTtcblxuaXBjUmVuZGVyZXIub24oJ2dldC10b2tlbi1hbmQtZmluZ2VycHJpbnQnLCBmdW5jdGlvbihldiwge3Rva2VuOiByYXdUb2tlbiwgZmluZ2VycHJpbnR9KSB7XG4gIGNvbnN0IHRva2VuID0gKHJhd1Rva2VuIHx8ICcnKS5yZXBsYWNlKC9cIi9nLCAnJyk7XG5cbiAgY29uc29sZS5sb2coYGdldC10b2tlbi1hbmQtZmluZ2VycHJpbnQ6IHRva2VuPSR7dG9rZW59IGZpbmdlcnByaW50PSR7ZmluZ2VycHJpbnR9YCk7XG4gIHdpbmRvdy50b2tlbiA9IHRva2VuO1xuICB3aW5kb3cuZmluZ2VycHJpbnQgPSBmaW5nZXJwcmludDtcblxuICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgndG9rZW4nLCB0b2tlbik7XG4gIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCdmaW5nZXJwcmludCcsIGZpbmdlcnByaW50KTtcbn0pO1xuaXBjUmVuZGVyZXIub24oJ2NyZWF0ZS10cmFuc3BvcnQnLCBmdW5jdGlvbihldiwgc3NyYywgdXNlcklkLCBhZGRyZXNzLCBwb3J0LCBjYikge1xuICBjb25zb2xlLmxvZygnY3JlYXRlLXRyYW5zcG9ydDonLCBzc3JjLCB1c2VySWQsIGFkZHJlc3MsIHBvcnQsIGNiKTtcbiAgVm9pY2VFbmdpbmUuZW5hYmxlKChlcnIpID0+IHtcbiAgICBjb25zb2xlLmxvZygnVm9pY2VFbmdpbmUuZW5hYmxlOicsIGVycik7XG4gIH0pO1xuICBWb2ljZUVuZ2luZS5jb25uZWN0KHNzcmMsIHVzZXJJZCwgYWRkcmVzcywgcG9ydCwgX2RlSW50ZXJvcChjYikpO1xufSk7XG5pcGNSZW5kZXJlci5vbignc2V0LW9uLXNwZWFraW5nLWNhbGxiYWNrJywgZnVuY3Rpb24oZXYsIGNiKSB7XG4gIGNvbnNvbGUubG9nKCdzZXQtb24tc3BlYWtpbmctY2FsbGJhY2s6JywgY2IpO1xuICBWb2ljZUVuZ2luZS5vblNwZWFraW5nKF9kZUludGVyb3AoY2IpKTtcbn0pO1xuaXBjUmVuZGVyZXIub24oJ3NldC1vbi12b2ljZS1jYWxsYmFjaycsIGZ1bmN0aW9uKGV2LCBjYikge1xuICBjb25zb2xlLmxvZygnc2V0LW9uLXZvaWNlLWNhbGxiYWNrOicsIGNiKTtcbiAgVm9pY2VFbmdpbmUub25Wb2ljZUFjdGl2aXR5KF9kZUludGVyb3AoY2IpKTtcbn0pO1xuaXBjUmVuZGVyZXIub24oJ29uLWNvbm5lY3Rpb24tc3RhdGUnLCBmdW5jdGlvbihldiwgY2IpIHtcbiAgY29uc29sZS5sb2coJ29uLWNvbm5lY3Rpb24tc3RhdGU6JywgY2IpO1xuICBWb2ljZUVuZ2luZS5vbkNvbm5lY3Rpb25TdGF0ZShfZGVJbnRlcm9wKGNiKSk7XG59KTtcbmlwY1JlbmRlcmVyLm9uKCdzZXQtZGV2aWNlLWNoYW5nZS1jYWxsYmFjaycsIGZ1bmN0aW9uKGV2LCBjYikge1xuICBjb25zb2xlLmxvZygnc2V0LWRldmljZS1jaGFuZ2UtY2FsbGJhY2s6JywgY2IpO1xuICBWb2ljZUVuZ2luZS5vbkRldmljZXNDaGFuZ2VkKF9kZUludGVyb3AoY2IpKTtcbn0pO1xuaXBjUmVuZGVyZXIub24oJ2dldC1pbnB1dC1kZXZpY2VzJywgZnVuY3Rpb24oZXYsIGNiKSB7XG4gIGNvbnNvbGUubG9nKCdnZXQtaW5wdXQtZGV2aWNlczonLCBjYik7XG4gIFZvaWNlRW5naW5lLmdldElucHV0RGV2aWNlcyhfZGVJbnRlcm9wKGNiKSk7XG59KTtcblsnc2V0RWNob0NhbmNlbGxhdGlvbicsICdzZXROb2lzZVN1cHByZXNzaW9uJywgJ3NldEF1dG9tYXRpY0dhaW5Db250cm9sJ10uZm9yRWFjaChmdW5jdGlvbihtZXRob2QpIHtcbiAgaXBjUmVuZGVyZXIub24obWV0aG9kLCBmdW5jdGlvbihldiwgZW5hYmxlZCkge1xuICAgIGNvbnNvbGUubG9nKGAke21ldGhvZH06YCwgZW5hYmxlZCk7XG4gICAgVm9pY2VFbmdpbmVbbWV0aG9kXShlbmFibGVkKTtcbiAgfSk7XG59KTtcbmlwY1JlbmRlcmVyLm9uKCdzZXQtaW5wdXQtZGV2aWNlJywgZnVuY3Rpb24oZXYsIGlucHV0RGV2aWNlSW5kZXgpIHtcbiAgY29uc29sZS5sb2coJ3NldC1pbnB1dC1kZXZpY2U6JywgaW5wdXREZXZpY2VJbmRleCk7XG4gIFZvaWNlRW5naW5lLmdldElucHV0RGV2aWNlcygoZGV2aWNlcykgPT4ge1xuICAgIGNvbnN0IGRldmljZSA9IGRldmljZXNbaW5wdXREZXZpY2VJbmRleF0uaWQ7XG4gICAgVm9pY2VFbmdpbmUuc2V0SW5wdXREZXZpY2UoZGV2aWNlKTtcbiAgfSk7XG59KTtcbmlwY1JlbmRlcmVyLm9uKCdzZXQtaW5wdXQtbW9kZScsIGZ1bmN0aW9uKGV2LCBtb2RlLCBvcHRpb25zKSB7XG4gIGNvbnNvbGUubG9nKCdzZXQtaW5wdXQtbW9kZTonLCBtb2RlLCBvcHRpb25zKTtcbiAgaWYgKE5BVElWRV9UT19SRUdVTEFSW21vZGVdID09PSBJbnB1dE1vZGVzLlBVU0hfVE9fVEFMSykge1xuICAgIG9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHt9LCBvcHRpb25zLCB7IGRlbGF5OiBvcHRpb25zLnB0dERlbGF5IH0pO1xuICB9XG4gIFZvaWNlRW5naW5lLnNldElucHV0TW9kZShOQVRJVkVfVE9fUkVHVUxBUlttb2RlXSwgb3B0aW9ucyk7XG59KTtcbmlwY1JlbmRlcmVyLm9uKCdnZXQtb3V0cHV0LWRldmljZXMnLCBmdW5jdGlvbihldiwgY2IpIHtcbiAgY29uc29sZS5sb2coJ2dldC1vdXRwdXQtZGV2aWNlczonLCBjYik7XG4gIFZvaWNlRW5naW5lLmdldE91dHB1dERldmljZXMoX2RlSW50ZXJvcChjYikpO1xufSk7XG5pcGNSZW5kZXJlci5vbignc2V0LW91dHB1dC12b2x1bWUnLCBmdW5jdGlvbihldiwgdm9sdW1lKSB7XG4gIGNvbnNvbGUubG9nKCdzZXQtb3V0cHV0LXZvbHVtZTonLCB2b2x1bWUpO1xuICBWb2ljZUVuZ2luZS5zZXRPdXRwdXRWb2x1bWUodm9sdW1lKTtcbn0pO1xuaXBjUmVuZGVyZXIub24oJ3NldC1zZWxmLW11dGUnLCBmdW5jdGlvbihldiwgbXV0ZSkge1xuICBjb25zb2xlLmxvZygnc2V0LXNlbGYtbXV0ZTonLCBtdXRlKTtcbiAgVm9pY2VFbmdpbmUuc2V0U2VsZk11dGUobXV0ZSk7XG59KTtcbmlwY1JlbmRlcmVyLm9uKCdzZXQtc2VsZi1kZWFmZW4nLCBmdW5jdGlvbihldiwgZGVhZikge1xuICBjb25zb2xlLmxvZygnc2V0LXNlbGYtZGVhZmVuOicsIGRlYWYpO1xuICBWb2ljZUVuZ2luZS5zZXRTZWxmRGVhZihkZWFmKTtcbn0pO1xuaXBjUmVuZGVyZXIub24oJ3NldC1sb2NhbC1tdXRlJywgZnVuY3Rpb24oZXYsIHVzZXJJZCwgbXV0ZSkge1xuICBjb25zb2xlLmxvZygnc2V0LWxvY2FsLW11dGU6JywgdXNlcklkLCBtdXRlKTtcbiAgVm9pY2VFbmdpbmUuc2V0TG9jYWxNdXRlKHVzZXJJZCwgbXV0ZSk7XG59KTtcbmlwY1JlbmRlcmVyLm9uKCdzZXQtbG9jYWwtdm9sdW1lJywgZnVuY3Rpb24oZXYsIHVzZXJJZCwgdm9sdW1lKSB7XG4gIGNvbnNvbGUubG9nKCdzZXQtbG9jYWwtdm9sdW1lOicsIHVzZXJJZCwgdm9sdW1lKTtcbiAgVm9pY2VFbmdpbmUuc2V0TG9jYWxWb2x1bWUodXNlcklkLCB2b2x1bWUpO1xufSk7XG5pcGNSZW5kZXJlci5vbignZGVzdHJveS10cmFuc3BvcnQnLCBmdW5jdGlvbihldikge1xuICBjb25zb2xlLmxvZygnZGVzdHJveS10cmFuc3BvcnQnKTtcbiAgVm9pY2VFbmdpbmUuZGlzY29ubmVjdCgpO1xufSk7XG5pcGNSZW5kZXJlci5vbignaGFuZGxlLXNwZWFraW5nJywgZnVuY3Rpb24oZXYsIHVzZXJJZCwgc3BlYWtpbmcpIHtcbiAgLy9jb25zb2xlLmxvZygnaGFuZGxlLXNwZWFraW5nOicsIHVzZXJJZCwgc3BlYWtpbmcpO1xuICBWb2ljZUVuZ2luZS5oYW5kbGVTcGVha2luZyh1c2VySWQsIHNwZWFraW5nKTtcbn0pO1xuaXBjUmVuZGVyZXIub24oJ2hhbmRsZS1zZXNzaW9uLWRlc2NyaXB0aW9uJywgZnVuY3Rpb24oZXYsIG9iaikge1xuICBjb25zb2xlLmxvZygnaGFuZGxlLXNlc3Npb24tZGVzY3JpcHRpb246Jywgb2JqKTtcbiAgVm9pY2VFbmdpbmUuaGFuZGxlU2Vzc2lvbkRlc2NyaXB0aW9uKG9iaik7XG59KTtcbmlwY1JlbmRlcmVyLm9uKCdtZXJnZS11c2VycycsIGZ1bmN0aW9uKGV2LCB1c2Vycykge1xuICBjb25zb2xlLmxvZygnbWVyZ2UtdXNlcnM6JywgdXNlcnMpO1xuICB1c2Vycy5mb3JFYWNoKCh1c2VyKSA9PiB7XG4gICAgVm9pY2VFbmdpbmUuY3JlYXRlVXNlcih1c2VyLmlkLCB1c2VyLnNzcmMpO1xuICB9KTtcbn0pO1xuaXBjUmVuZGVyZXIub24oJ2Rlc3Ryb3ktdXNlcicsIGZ1bmN0aW9uKGV2LCB1c2VySWQpIHtcbiAgY29uc29sZS5sb2coJ2Rlc3Ryb3ktdXNlcjonLCB1c2VySWQpO1xuICBWb2ljZUVuZ2luZS5kZXN0cm95VXNlcih1c2VySWQpO1xufSk7XG4iXX0=